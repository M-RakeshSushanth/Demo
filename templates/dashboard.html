<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoneAI | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-50 flex h-screen overflow-hidden">

    <aside class="w-64 bg-indigo-900 text-white flex flex-col shrink-0">
        <div class="p-6">
            <h1 class="text-2xl font-bold flex items-center gap-2 italic">
                <i class="fas fa-bone text-indigo-400"></i> BoneAI
            </h1>
        </div>
        <nav class="flex-1 px-4 space-y-2">
            <a href="/dashboard" class="flex items-center gap-3 p-3 bg-indigo-800 rounded-xl transition">
                <i class="fas fa-columns w-5"></i> Dashboard
            </a>
            <a href="/profile" class="flex items-center gap-3 p-3 hover:bg-indigo-800 rounded-xl transition">
                <i class="fas fa-history w-5"></i> Scan History
            </a>
        </nav>
        <div class="p-4 border-t border-indigo-800">
            <a href="/logout" class="flex items-center gap-3 p-3 text-red-300 hover:bg-red-900/30 rounded-xl transition">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-8">
        <div class="max-w-4xl mx-auto">
            <header class="mb-10">
                <h2 class="text-3xl font-bold text-slate-800">Bone Density Analysis</h2>
                <p class="text-slate-500">Upload a digital X-ray scan for instant AI diagnosis.</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                    <div id="dropzone" 
                         class="relative border-2 border-dashed border-slate-200 rounded-2xl h-64 flex flex-col items-center justify-center bg-slate-50 hover:bg-indigo-50 hover:border-indigo-300 transition cursor-pointer group"
                         onclick="document.getElementById('file').click()">
                        
                        <div id="upload-placeholder" class="text-center">
                            <div class="w-16 h-16 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition">
                                <i class="fas fa-upload text-indigo-600"></i>
                            </div>
                            <p class="text-sm font-semibold text-slate-600">Click to upload X-ray</p>
                            <p class="text-xs text-slate-400 mt-1">Supports JPG, PNG</p>
                        </div>

                        <img id="preview" class="hidden absolute inset-0 w-full h-full object-cover rounded-2xl" />
                        <input type="file" id="file" class="hidden" accept="image/*" onchange="handlePreview(this)">
                    </div>

                    <button id="upBtn" onclick="upload()" 
                        class="w-full mt-6 bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition-all flex items-center justify-center gap-2">
                        <span>Run Analysis</span>
                    </button>

                    <div id="loader" class="hidden mt-6 text-center text-indigo-600 font-semibold animate-pulse">
                        <i class="fas fa-circle-notch fa-spin mr-2"></i> Processing Image...
                    </div>
                </div>

                <div class="flex flex-col">
                    <div id="empty-state" class="bg-slate-100 border-2 border-dashed border-slate-200 rounded-3xl flex-1 flex flex-center items-center justify-center p-10 text-center text-slate-400">
                        <div>
                            <i class="fas fa-notes-medical text-4xl mb-4 opacity-20"></i>
                            <p>Results will appear here <br> after analysis.</p>
                        </div>
                    </div>

                    <div id="resBox" class="hidden bg-white p-8 rounded-3xl shadow-sm border border-slate-200 animate-fadeIn">
                        <div class="flex items-center gap-3 mb-6">
                            <div id="resIcon" class="w-12 h-12 rounded-full flex items-center justify-center"></div>
                            <div>
                                <p class="text-xs uppercase tracking-widest text-slate-400 font-bold">Diagnosis</p>
                                <h3 id="resText" class="text-xl font-black"></h3>
                            </div>
                        </div>
                        
                        <div class="bg-slate-50 p-4 rounded-2xl mb-6">
                            <div class="flex justify-between mb-2">
                                <span class="text-sm text-slate-500 font-medium">AI Confidence</span>
                                <span id="resConf" class="text-sm font-bold text-indigo-600"></span>
                            </div>
                            <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                                <div id="confBar" class="bg-indigo-500 h-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>

                        <div id="downloadArea" class="mt-6 border-t border-slate-100 pt-6">
                            <a id="pdfLink" href="#" target="_blank" 
                               class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-black transition flex items-center justify-center gap-2">
                                <i class="fas fa-file-pdf"></i> Download Medical Report
                            </a>
                        </div>

                        <div class="mt-4 text-[10px] text-slate-400 italic leading-relaxed">
                            *This is an AI screening tool. Results are generated via deep learning models and must be verified by a medical professional.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function handlePreview(input) {
            const preview = document.getElementById('preview');
            const placeholder = document.getElementById('upload-placeholder');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function upload() {
            const f = document.getElementById('file').files[0];
            if(!f) return alert("Please select an X-ray first!");
            
            const btn = document.getElementById('upBtn');
            const loader = document.getElementById('loader');
            const resBox = document.getElementById('resBox');
            const emptyState = document.getElementById('empty-state');
            const pdfLink = document.getElementById('pdfLink');

            btn.classList.add('hidden');
            loader.classList.remove('hidden');
            resBox.classList.add('hidden');

            const fd = new FormData();
            fd.append("file", f);

            try {
                const res = await fetch("/predict", {method: "POST", body: fd});
                const data = await res.json();

                loader.classList.add('hidden');
                btn.classList.remove('hidden');
                emptyState.classList.add('hidden');
                resBox.classList.remove('hidden');

                const isNormal = data.result.includes("Normal");
                
                // Set UI Colors
                const resIcon = document.getElementById('resIcon');
                resIcon.className = `w-12 h-12 rounded-full flex items-center justify-center ${isNormal ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`;
                resIcon.innerHTML = isNormal ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-triangle"></i>';
                
                document.getElementById('resText').innerText = data.result;
                document.getElementById('resText').className = `text-xl font-black ${isNormal ? 'text-green-700' : 'text-red-700'}`;
                document.getElementById('resConf').innerText = data.confidence;
                document.getElementById('confBar').style.width = data.confidence;

                // UPDATE PDF LINK DYNAMICALLY
                if(data.scan_id) {
                    pdfLink.href = `/report/${data.scan_id}`;
                } else {
                    // Fallback if your predict route doesn't return scan_id yet
                    pdfLink.onclick = () => alert("Go to Scan History to download this report.");
                }

            } catch (err) {
                alert("Server error. Check if the model is loaded.");
                btn.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</body>
</html>